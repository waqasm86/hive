name: PR Requirements Check

on:
  pull_request_target:
    types: [opened, reopened, edited, synchronize]

jobs:
  check-requirements:
    # Run requirements check only on the upstream repository (avoid auto-closing PRs on forks)
    if: github.repository == 'adenhq/hive'
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      pull-requests: write
      issues: write

    steps:
      - name: Check PR has linked issue with assignee
        uses: actions/github-script@v7
        with:
          script: |
            const core = require('@actions/core');

            const pr = context.payload.pull_request;
            const prNumber = pr.number;
            const prBody = pr.body || '';
            const prTitle = pr.title || '';
            const prLabels = (pr.labels || []).map(l => l.name);

            // Allow micro-fix and documentation PRs without a linked issue
            const isMicroFix = prLabels.includes('micro-fix') || /micro-fix/i.test(prTitle);
            const isDocumentation = prLabels.includes('documentation') || /\bdocs?\b/i.test(prTitle);
            if (isMicroFix || isDocumentation) {
              const reason = isMicroFix ? 'micro-fix' : 'documentation';
              console.log(`PR #${prNumber} is a ${reason}, skipping issue requirement.`);
              return;
            }

            // Extract issue numbers from body and title.
            // Matches: fixes #123, closes #123, resolves #123, owner/repo#123, or issue URLs.
            const issuePattern = /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)?\s*(?:https?:\/\/github\.com\/([^/\s]+)\/([^/\s]+)\/(?:issues|pull)\/(\d+)|([A-Za-z0-9_.-]+)\/([A-Za-z0-9_.-]+)#(\d+)|#(\d+))/gi;

            const repoSlug = `${context.repo.owner}/${context.repo.repo}`.toLowerCase();
            const allText = `${prTitle} ${prBody}`;
            const matches = [...allText.matchAll(issuePattern)];
            const issueNumbers = [
              ...new Set(
                matches
                  .map((m) => {
                    if (m[3]) {
                      const owner = m[1];
                      const repo = m[2];
                      return `${owner}/${repo}`.toLowerCase() === repoSlug
                        ? parseInt(m[3], 10)
                        : null;
                    }
                    if (m[6]) {
                      const owner = m[4];
                      const repo = m[5];
                      return `${owner}/${repo}`.toLowerCase() === repoSlug
                        ? parseInt(m[6], 10)
                        : null;
                    }
                    if (m[7]) {
                      return parseInt(m[7], 10);
                    }
                    return null;
                  })
                  .filter((n) => Number.isInteger(n))
              ),
            ];

            console.log(`PR #${prNumber}:`);
            console.log(`  Found issue references: ${issueNumbers.length > 0 ? issueNumbers.join(', ') : 'none'}`);

            if (issueNumbers.length === 0) {
              const message = `## PR Closed - Requirements Not Met

            This PR has been automatically closed because it doesn't meet the requirements.

            **Missing:** No linked issue found.

            **To fix:**
            1. Create or find an existing issue for this work
            2. Assign yourself to the issue
            3. Re-open this PR and add \`Fixes #123\` in the description

            **Exception:** To bypass this requirement, you can:
            - Add the \`micro-fix\` label or include \`micro-fix\` in your PR title for trivial fixes
            - Add the \`documentation\` label or include \`doc\`/\`docs\` in your PR title for documentation changes

            **Micro-fix requirements** (must meet ALL):
            | Qualifies | Disqualifies |
            |-----------|--------------|
            | < 20 lines changed | Any functional bug fix |
            | Typos & Documentation & Linting | Refactoring for "clean code" |
            | No logic/API/DB changes | New features (even tiny ones) |

            **Why is this required?** See #472 for details.`;

              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
              });

              const botComment = comments.data.find(
                (c) => c.user.type === 'Bot' && c.body.includes('PR Closed - Requirements Not Met')
              );

              if (!botComment) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: message,
                });
              }

              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                state: 'closed',
              });

              core.setFailed('PR must reference an issue');
              return;
            }

            // Relaxed requirement: as long as the PR references at least one issue,
            // do not require the PR author to be listed as an assignee on that issue.
            // This simplifies contribution from forks where contributors cannot be
            // added as assignees by upstream maintainers.
            if (issueNumbers.length > 0) {
              console.log(`PR #${prNumber} references issues: ${issueNumbers.join(', ')}, requirement satisfied.`);
            }
